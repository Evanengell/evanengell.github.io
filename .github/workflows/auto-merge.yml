name: Auto-merge to Master on Success

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: |
          echo "ğŸ”¨ Building and validating..."
          npm run build

          # Validate build output
          if [ ! -f "index.html" ]; then
            echo "âŒ ERROR: Build failed - index.html not found!"
            exit 1
          fi

          if ! grep -q "index-.*\.js" index.html; then
            echo "âŒ ERROR: Build failed - no hashed assets in index.html!"
            exit 1
          fi

          echo "âœ… Build and validation successful"
          echo "ğŸ“Š Built files:"
          ls -lh assets/index-*.js assets/index-*.css 2>/dev/null || echo "Assets not found in expected location"

      - name: Auto-merge to master
        if: success()
        run: |
          echo "ğŸš€ Starting auto-merge to master..."
          echo "ğŸ“… Merge time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸŒ¿ Source branch: ${{ github.ref_name }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch latest master
          echo "ğŸ“¥ Fetching latest master..."
          git fetch origin master

          # Check if merge is possible
          echo "ğŸ” Checking merge feasibility..."
          git checkout master

          if git merge --no-commit --no-ff ${{ github.ref_name }} 2>&1; then
            echo "âœ… Merge check passed, proceeding with actual merge..."
            git merge --abort 2>/dev/null || true
            git merge ${{ github.ref_name }} --no-edit -m "ğŸš€ Auto-deploy: Merge ${{ github.ref_name }}"
          else
            echo "âŒ ERROR: Merge conflict detected!"
            echo "Please resolve conflicts manually and merge to master."
            exit 1
          fi

          # Push to master with retry logic
          echo "ğŸ“¤ Pushing to master..."
          max_retries=4
          retry_count=0
          retry_delay=2

          while [ $retry_count -lt $max_retries ]; do
            if git push origin master; then
              echo "âœ… Successfully pushed to master!"
              echo "ğŸ‰ Deploy pipeline will start automatically"
              exit 0
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "âš ï¸  Push failed, retrying in ${retry_delay}s... (attempt $retry_count/$max_retries)"
                sleep $retry_delay
                retry_delay=$((retry_delay * 2))
              fi
            fi
          done

          echo "âŒ ERROR: Failed to push after $max_retries attempts"
          exit 1
